// src/App.tsx
import React, { useState } from "react";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Textarea } from "@/components/ui/textarea";
import { Input } from "@/components/ui/input";
import { Progress } from "@/components/ui/progress";
import { Download, Mic, Upload } from "lucide-react";
import { saveAs } from "file-saver";

const mockOCR = async (file: File): Promise<string> => {
  return new Promise((resolve) => setTimeout(() => resolve("Artikel 101178\nArtikel 202034\nArtikel 394102"), 2000));
};

const mockArticleDB = {
  "101178": "Kabelbinder 20cm",
  "202034": "Schraube M6x40",
  "394102": "DÃ¼bel 8mm"
};

type Entry = {
  id: string;
  name: string;
  qty: number;
};

export default function App() {
  const [step, setStep] = useState(1);
  const [ocrText, setOcrText] = useState("");
  const [file, setFile] = useState<File | null>(null);
  const [progress, setProgress] = useState(0);
  const [entries, setEntries] = useState<Entry[]>([]);
  const [input, setInput] = useState("");

  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setFile(file);
      setProgress(30);
      const text = await mockOCR(file);
      setOcrText(text);
      setProgress(100);
    }
  };

  const handleSpeechInput = () => {
    const match = input.match(/(\d{6}).*(\d+)/);
    if (!match) return alert("Eingabe nicht erkannt");
    const id = match[1];
    const qty = parseInt(match[2]);
    const name = mockArticleDB[id];
    if (!name) return alert("Artikel nicht gefunden");
    if (!window.confirm(`Artikel: ${name}\nMenge: ${qty}\nSpeichern?`)) return;
    setEntries([...entries, { id, name, qty }]);
    setInput("");
  };

  const handleExport = () => {
    const csv = ["Artikelnummer,Bezeichnung,Menge", ...entries.map(e => `${e.id},${e.name},${e.qty}`)].join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    saveAs(blob, "inventur.csv");
  };

  return (
    <main className="p-4 max-w-xl mx-auto space-y-6">
      <h1 className="text-2xl font-bold">ðŸ“¦ Inventur App</h1>

      {step === 1 && (
        <Card>
          <CardContent className="space-y-4 p-4">
            <Input type="file" accept="application/pdf" onChange={handleFileUpload} />
            <Progress value={progress} />
            {ocrText && <Textarea value={ocrText} readOnly rows={6} />}
            <Button onClick={() => setStep(2)} disabled={!ocrText}>Weiter</Button>
          </CardContent>
        </Card>
      )}

      {step === 2 && (
        <Card>
          <CardContent className="space-y-4 p-4">
            <div className="flex items-center gap-2">
              <Input value={input} onChange={(e) => setInput(e.target.value)} placeholder="Artikel 101178 drei StÃ¼ck" />
              <Button onClick={handleSpeechInput}><Mic /></Button>
            </div>
            <ul className="list-disc pl-6">
              {entries.map((e, i) => (
                <li key={i}>{e.id} â€“ {e.name} â€“ {e.qty} StÃ¼ck</li>
              ))}
            </ul>
            <Button onClick={() => setStep(3)}>Weiter</Button>
          </CardContent>
        </Card>
      )}

      {step === 3 && (
        <Card>
          <CardContent className="space-y-4 p-4">
            <Textarea readOnly rows={entries.length + 2} value={["Artikelnummer,Bezeichnung,Menge", ...entries.map(e => `${e.id},${e.name},${e.qty}`)].join("\n")} />
            <Button onClick={handleExport}><Download className="mr-2" /> CSV Export</Button>
          </CardContent>
        </Card>
      )}
    </main>
  );
}
