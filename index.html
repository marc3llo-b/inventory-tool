<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inventur Tool</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; max-width: 600px; margin: auto; }
    h1 { font-size: 1.5rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
    .mba-logo {
      background: radial-gradient(circle at 30% 30%, #2980b9, #2c3e50);
      color: white;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .step { display: none; }
    .step.active { display: block; }
    .mic-btn {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: green;
      color: white;
      font-size: 2.5rem;
      border: none;
      margin: 1rem auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .mic-btn.active {
      background: orange;
    }
    #status2, #feedback, #best√§tigung, #micStatus, #tabelleHinweis {
      margin-top: 1rem;
      text-align: center;
      font-weight: bold;
    }
    #feedback.success { color: green; }
    #feedback.error { color: red; }
  </style>
  <link rel="manifest" href="manifest.json">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
<script>
  window.Tesseract = window.Tesseract || {};
  Tesseract.options = {
    langPath: './tessdata'
  };
</script>
</head>
<body>
  <h1><div class="mba-logo">MBA</div>Inventur Tool</h1>

  <div class="step active" id="step1">
    <h2>üì• Schritt 1: St√ºckliste hochladen</h2>
    <input type="file" id="pdfInput" accept="application/pdf" />
    <div id="status1"></div>
<label><input type="checkbox" id="togglePreview" checked> Vorschau anzeigen</label>
<div id="csvPreview" style="margin-top:1rem; font-family:monospace; white-space:pre; background:#f4f4f4; padding:1rem; border-radius:5px; display:none;"></div>
    <progress id="ocrProgress" value="0" max="100" style="width: 100%; display: none; margin-top: 0.5rem;"></progress>
    <div id="ocrText" style="display: none;"></div>
    <div style="display: flex; justify-content: flex-end; margin-top: 1rem;">
      <button id="weiterButton" onclick="zeigeSchritt(2)" disabled>Weiter</button>
    </div>
  </div>

  <div class="step" id="step2">
    <h2>üé§ Schritt 2: Spracheingabe</h2>
    <p><small>Halte den Button gedr√ºckt und sage z.‚ÄØB.:<br><b>Artikel 101178 drei St√ºck</b></small></p>
    <button class="mic-btn" id="micButton">üé§</button>
    <div id="micStatus"></div>
    <div id="tabelleHinweis"></div>
    <div id="feedback"></div>
    <div id="artikelName" style="margin-top: 1rem; text-align: center; font-style: italic;"></div>
    <div id="best√§tigung"></div>
    <div id="status2"></div>
    <div style="display: flex; justify-content: space-between; margin-top: 2rem;">
      <button onclick="zeigeSchritt(1)">Zur√ºck</button>
      <button onclick="zeigeSchritt(3)">Weiter</button>
    </div>
  </div>

  <div class="step" id="step3">
    <h2>üì§ Schritt 3: Exportieren</h2>
    <button onclick="exportExcel()">üìÑ Excel exportieren</button>
    <div style="margin-top: 1rem;">
      <label for="email">üìß E-Mail f√ºr Versand:</label><br>
      <input type="email" id="email" placeholder="z.‚ÄØB. max@firma.de" style="width: 100%; margin: 0.5rem 0; padding: 0.5rem;" />
      <button onclick="sendEmail()">‚úâÔ∏è Per E-Mail versenden</button>
    </div>
    <div style="display: flex; justify-content: flex-start; margin-top: 2rem;">
      <button onclick="zeigeSchritt(2)">Zur√ºck</button>
    </div>
  </div>

  <script>
    function zeigeSchritt(nr) {
      document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
      const ziel = document.getElementById(`step${nr}`);
      if (ziel) ziel.classList.add('active');
    }

    const micButton = document.getElementById("micButton");
    const micStatus = document.getElementById("micStatus");
    const feedback = document.getElementById("feedback");
    const best√§tigung = document.getElementById("best√§tigung");
    const status2 = document.getElementById("status2");
    const tabelleHinweis = document.getElementById("tabelleHinweis");

    micButton.addEventListener("mousedown", () => {
      micButton.classList.add("active");
      micStatus.textContent = "üéôÔ∏è Aufnahme l√§uft ...";
      feedback.textContent = "";
      best√§tigung.textContent = "";
      startListening();
    });

    micButton.addEventListener("mouseup", () => {
      if (recognition) recognition.stop();
      micButton.classList.remove("active");
      micStatus.textContent = "Aufnahme beendet";
    });

    let recognition;
    let artikelDaten = {
      "1000012": { alt: "101014", name: "Gleichrichter Hubwerk, blau", menge: 0 },
      "1000025": { alt: "101036", name: "Hakenmaulsicherung zu HBC-Haken Gr. 1.6", menge: 0 },
      "1000100": { alt: "101178", name: "Akku FLEX", menge: 0 }
    };

    function startListening() {
      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'de-DE';
      recognition.interimResults = false;
      recognition.onresult = (event) => {
        const text = event.results[0][0].transcript;
        status2.textContent = `Verstanden: ${text}`;
        auswerten(text);
      };
      recognition.start();
    }

    function auswerten(text) {
      const artikelnummer = text.match(/\d{6,7}/)?.[0];
      const menge = parseInt(text.match(/\d+(?=\s*St(√º|u)ck|$)/)?.[0]);
      let gefunden = false;
      for (const [neu, daten] of Object.entries(artikelDaten)) {
        if (neu === artikelnummer || daten.alt === artikelnummer) {
          document.getElementById('artikelName').textContent = `Bezeichnung: ${daten.name}`;
          tabelleHinweis.innerHTML = `<span style='color:green;'>‚úîÔ∏è Artikel in Tabelle vorhanden</span>`;
          feedback.textContent = '';
          best√§tigung.innerHTML = `<div style='margin-top:1rem;'>Verstandene Anzahl: <b>${menge || "?"}</b><br>‚úîÔ∏è Korrekt? <button onclick="best√§tige('${neu}', ${menge})">Ja</button> <button onclick="feedback.textContent=''; best√§tigung.textContent='';">Nein</button></div>`;
          gefunden = true;
          break;
        }
      }
      if (!gefunden) {
        document.getElementById('artikelName').textContent = '';
        tabelleHinweis.innerHTML = `<span style='color:red;'>‚ùå Artikel nicht vorhanden</span>`;
        feedback.textContent = '';
        best√§tigung.textContent = '';
      }
    }

    function best√§tige(nummer, menge) {
      artikelDaten[nummer].menge += menge;
      feedback.textContent = "‚úÖ Eingabe gespeichert.";
      best√§tigung.textContent = "";
    }

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

const pdfInput = document.getElementById("pdfInput");
    pdfInput.addEventListener("change", async function (e) {
      const file = e.target.files[0];
      if (!file) return;
      const pdfURL = URL.createObjectURL(file);
      const loadingTask = pdfjsLib.getDocument(pdfURL);
      const pdf = await loadingTask.promise;

      const progress = document.getElementById("ocrProgress");
      progress.style.display = "block";
      progress.value = 0;

      const worker = await Tesseract.createWorker({
        logger: m => {
          if (m.status === 'recognizing text' && m.progress !== undefined) {
            const percent = Math.round(m.progress * 100);
            progress.value = percent;
            document.getElementById("status1").textContent = `Texterkennung: ${percent}% auf Seite ${currentPage}`;
          }
        }
      });
      await worker.load();
      await worker.loadLanguage('deu', './tessdata');
      await worker.initialize('deu');
      await worker.setParameters({
        tessedit_ocr_engine_mode: '1',
        tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789.- '
      });

      let combinedText = "";
      const totalPages = pdf.numPages;
let currentPage = 0;
      for (let i = 1; i <= totalPages; i++) {
        currentPage = i;
        document.getElementById("status1").textContent = `Verarbeite Seite ${i} von ${pdf.numPages}`;
        const page = await pdf.getPage(i);
        const viewport = page.getViewport({ scale: 2 });
        const canvas = document.createElement("canvas");
        document.getElementById("previewContainer").appendChild(canvas);
        if (!document.getElementById("togglePreview").checked) canvas.style.display = "none";
        canvas.style.display = "block";
        canvas.style.maxWidth = "100%";
        canvas.style.margin = "1rem auto";
        const context = canvas.getContext("2d");
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        await page.render({ canvasContext: context, viewport: viewport }).promise;
        const { data: { text } } = await worker.recognize(canvas);
        combinedText += text + "\n";
      }

      await worker.terminate();

      document.getElementById("ocrText").textContent = combinedText;
      document.getElementById("csvPreview").style.display = "block";
      let csvOutput = "Artikel Nr.;Alt;Bezeichnung;Menge
";
      for (const [neu, val] of Object.entries(artikelDaten)) {
        csvOutput += `${neu};${val.alt};${val.name};${val.menge}
`;
      }
      document.getElementById("csvPreview").textContent = csvOutput;
      document.getElementById("status1").textContent = "‚úÖ Texterkennung abgeschlossen.";
      progress.value = 100;
      setTimeout(() => progress.style.display = 'none', 1500);
      document.getElementById("weiterButton").disabled = false;
    });

    function sendEmail() {
      const empfaenger = document.getElementById("email").value;
      if (!empfaenger) {
        alert("Bitte gib eine E-Mail-Adresse ein.");
        return;
      }
      const body = encodeURIComponent("Die Inventurdatei wurde exportiert. Bitte finde sie im Anhang oder lade sie hier herunter: inventur_ergebnis.csv");
      window.location.href = `mailto:${empfaenger}?subject=Inventurergebnis&body=${body}`;
    }

    function exportExcel() {
      let csv = "Artikel Nr.;Alt;Bezeichnung;Menge\n";
      for (const [neu, val] of Object.entries(artikelDaten)) {
        csv += `${neu};${val.alt};${val.name};${val.menge}\n`;
      }
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "inventur_ergebnis.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
  </script>
</body>
</html>
